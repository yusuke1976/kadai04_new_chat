<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lineé¢¨ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="css/samplei.css">
</head>
<body>

    <div id="loader">
        <img src="jpg/logo.jpg">
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
    <div>
        <div>åå‰ï¼š<input type="text" id="uname"> </div>
        <div>
            <textarea id="text" cols="80" rows="7" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            <button id="send">é€ä¿¡</button>
        </div>
        <div id="output"></div>
    </div>

    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <!-- ä»¥ä¸‹JavaScripté ˜åŸŸ -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <!-- ä»¥ä¸‹Firebase -->
    <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildRemoved, onChildChanged }
    from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
    
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "-secret-",
        authDomain: "-secret-",
        projectId: "-secret-",
        storageBucket: "-secret-",
        messagingSenderId: "-secret-",
        appId: "-secret-"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app); 
    const dbRef = ref(db,"chat");

    // ãƒ­ãƒ¼ãƒ€ãƒ¼ç”»åƒã‚’0.5ç§’è¡¨ç¤ºã™ã‚‹
    window.addEventListener('load', function() {
        setTimeout(function() {
            document.getElementById('loader').style.display = 'none';
        }, 900); // 0.9ç§’ï¼ˆ900ãƒŸãƒªç§’ï¼‰å¾Œã«ãƒ­ãƒ¼ãƒ€ãƒ¼ç”»åƒã‚’éè¡¨ç¤ºã«ã™ã‚‹
    });    
        
    send.addEventListener('click', () => {
    const now = new Date();
    const nowYear = now.getFullYear(); 
    const nowMon = ('0' + (now.getMonth() + 1)).slice(-2);
    const nowDate = ('0' +  now.getDate()).slice(-2);
    const nowHour = ('0' +  now.getHours()).slice(-2);
    const nowMinute = ('0' + now.getMinutes()).slice(-2);
    const nowSecond = ('0' + now.getSeconds()).slice(-2);
    
    //ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ç‚¹ã®æ—¥æ™‚ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
    //console.log(`${nowYear}/${nowMon}/${nowDate} ${nowHour}:${nowMinute}`);
    const time = nowYear+ '/' + nowMon + '/' + nowDate + ' ' + nowHour + ':' + nowMinute + ':' + nowSecond; 
    
    //ãƒ‡ãƒ¼ã‚¿ç™»éŒ²(Click)
//    $("#send").on("click",function(){
        const msg = {
            uname : $("#uname").val(),
            text  : $("#text").val(),
            time
        }
        const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
        // console.log(datestamp);
        set(newPostRef,msg);       
    });
   
        
    //æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    onChildAdded(dbRef,function(data){
        const msg = data.val();
        const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEY
        // let h = '<div class="message-bubble ' + (msg.uname === $("#uname").val() ? 'sent' : 'received') + '">';
        let h = '<div class="message-bubble ' + (msg.uname === $("#uname").val() ? 'sent' : 'received') + '" id="msg-' + key + '">';
        h += '<p>';
        h += msg.time;
        h += '<br>';
        h += msg.uname;            
        h += '<br>';    
        h += '<span contentEditable = "true" id="'+key+'_update">'+msg.text+'</span>';
        // h += msg.text;
        h += '<br>';
        h += '<button class="remove" data-key="'+key+'">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤</button>'
        h += '<button class="update" data-key="'+key+'">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿®æ­£</button>'
        h += '</p>';
        h += '</div>';
        $("#output").append(h);
        $("#output").scrollTop($("#output")[0].scrollHeight);

        // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå¾Œã«ã€ä¸­èº«ã‚’å‰Šé™¤ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ğŸ¤—
        $("#uname").val("");
        $("#text").val("");

    });

    //å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click",".remove",function(){
        const key = $(this).attr("data-key");
        const remove_item = ref(db,"chat/"+key);
        remove(remove_item);
    });
    

    //æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click",".update",function(){
        const key = $(this).attr("data-key");
        update(ref(db,"chat/"+key),{
            text: $("#"+key+'_update').html()
        });
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    // onChildRemoved(dbRef, (data) => {
    //     $("#"+data.key).remove();
    // });

    onChildRemoved(dbRef, (data) => {
    $("#msg-" + data.key).remove();
    });

    
    // onChildChanged(dbRef, (data) => {
    //     $("#"+data.key+'_update').html(data.val().text);
    //     $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
    // });

    
    //console.log(time);
    //send.innerText = `åˆå›ä¿å­˜ ${nowYear}/${nowMon}/${nowDate} ${nowHour}:${nowMinute}`;
//    });
    
    //console.log(time); 

    
    
    
    //æœ€åˆã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†onSnapshotã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    // onChildAdded(dbRef,function(data){
    //     const msg = data.val();
    //     const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯KEY
    //     let h = '<p>';
    //         h += msg.uname;
    //         h += '<br>';
            //h += dete;
            //h += '<br>';
    //         h += msg.text;
    //         h += '</p>';
    //         $("#output").append(h);
    // });

</script>
</body>
</html>




